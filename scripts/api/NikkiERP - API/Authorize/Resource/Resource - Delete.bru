meta {
  name: Resource - Delete
  type: http
  seq: 3
}

delete {
  url: {{api_host}}/v1/authorize/resources/{{resource_name}}
  body: none
  auth: inherit
}

script:post-response {
  const status = res.getStatus();
  let body;
  
  try {
    body = res.getBody();
    console.log("ğŸ“¦ Response:", body);
  } catch (e) {
    console.warn("âš ï¸ Failed to parse body or body is empty:", e);
    body = {};
  }
  
  test("Status should be 2xx or 400", function () {
    expect([200, 204, 400]).to.include(status);
  });
  
  if (status >= 200 && status < 300) {
    test("Response should contain id and deletedAt", function () {
      expect(body).to.have.property("id").that.is.a("string");
      expect(body).to.have.property("deletedAt").that.is.a("number");
    });
  
    bru.deleteVar("resource_id");
    bru.deleteVar("resource_name");
    bru.deleteVar("etag");
    console.log("ğŸ§¹ Cleared resource_id, resource_name, etag from environment variables.");
  }
  
  if (status === 400) {
    test("Should have code and details fields", function () {
      expect(body).to.have.property("code", "validation_error");
      expect(body).to.have.property("details").that.is.an("object");
    });
  
    const details = body.details || {};
  
    if (details.name) {
      test("Handle invalid name format", function () {
        expect(details.name).to.equal("must be in a valid format");
      });
    }
  
    if (details.id) {
      test("Handle resource not found", function () {
        expect(details.id).to.equal("resource not found");
      });
    }
  
    if (details.actions || details.entitlements) {
      test("Handle constraint violations", function () {
        if (details.actions) {
          expect(details.actions).to.be.a("string");
        }
        if (details.entitlements) {
          expect(details.entitlements).to.be.a("string");
        }
      });
    }
  }
  
}

settings {
  encodeUrl: true
}
