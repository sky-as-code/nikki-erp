meta {
  name: Action - Delete
  type: http
  seq: 3
}

delete {
  url: {{api_host}}/v1/authorize/actions/{{action_id}}
  body: none
  auth: inherit
}

script:post-response {
  const status = res.getStatus();
  let body;
  
  try {
    body = res.getBody();
    console.log("📦 Response:", body);
  } catch (e) {
    console.warn("⚠️ Failed to parse body or body is empty:", e);
    body = {};
  }
  
  test("Status should be 2xx or 400", function () {
    expect([200, 204, 400]).to.include(status);
  });
  
  if (status >= 200 && status < 300) {
    test("Response should contain id and deletedAt", function () {
      expect(body).to.have.property("id").that.is.a("string");
      expect(body).to.have.property("deletedAt").that.is.a("number");
    });
  
    bru.deleteVar("action_id");
    bru.deleteVar("action_name");
    bru.deleteVar("etag");
    console.log("🧹 Deleted variables: action_id, action_name, etag");
  }
  
  if (status === 400) {
    test("Should have code and details fields", function () {
      expect(body).to.have.property("code", "validation_error");
      expect(body).to.have.property("details").that.is.an("object");
    });
  
    const details = body.details || {};
  
    if (details.name === "must be in a valid format") {
      test("Should catch invalid name format", function () {
        expect(details.name).to.equal("must be in a valid format");
      });
    }
  
    if (details.id === "action not found") {
      test("Should catch action not found", function () {
        expect(details.id).to.equal("action not found");
      });
    }
  
    if (details.entitlements) {
      test("Should catch constraint violations on entitlements", function () {
        expect(details.entitlements).to.be.a("string");
      });
    }
  }
  
}

settings {
  encodeUrl: true
}
