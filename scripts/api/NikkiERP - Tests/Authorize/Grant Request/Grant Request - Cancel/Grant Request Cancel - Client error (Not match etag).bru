meta {
  name: Grant Request Cancel - Client error (Not match etag)
  type: http
  seq: 2
}

post {
  url: {{api_host}}/v1/authorize/grant-requests/{{grant_req_id}}/cancel
  body: json
  auth: inherit
}

body:json {
  {
    "responderId": "{{grant_requestor_id}}",
    "etag": "1758272141847611111"
  }
}

script:post-response {
  let body;
  let isJson = true;
  
  try {
      body = res.getBody();
      console.log("üì• Response body:", body);
  } catch (e) {
      isJson = false;
      expect.fail("‚ùå Response is not valid JSON");
  }
  
  const statusCode = res.getStatus();
  
  // ================= SUCCESS =================
  if (statusCode === 200 && isJson) {
      test("‚úÖ Status code is 200 OK", function () {
          expect(statusCode).to.eql(200);
      });
  
      test("‚úÖ Response has required fields", function () {
          expect(body).to.have.property("id");
          expect(body).to.have.property("etag");
          expect(body).to.have.property("updatedAt");
      });
  
      bru.setVar("grant_req_id", body.id);
      bru.setVar("grant_req_etag", body.etag);
      console.log("‚úÖ Saved grant_req_id and grant_req_etag");
  }
  
  // ================= VALIDATION ERRORS =================
  else if (statusCode === 400 && isJson && body.code === "validation_error") {
      test("‚ùå Validation error received", function () {
          expect(body).to.have.property("code", "validation_error");
          expect(body.details).to.be.an("object");
      });
  
      const details = body.details || {};
      console.warn("‚ö†Ô∏è Validation details:", JSON.stringify(details, null, 2));
  
      // ---------- Case: Etag mismatch ----------
      if (details.etag && /mismatched/i.test(details.etag)) {
          test("‚ùå Case: etag_mismatch", function () {
              expect(details).to.have.property("etag");
              expect(details.etag).to.match(/mismatched/i);
          });
      }
  
      // ---------- Case: Not found ----------
      else if (details.grant_request_id && /not found/i.test(details.grant_request_id)) {
          test("‚ùå Case: grant_request_not_found", function () {
              expect(details).to.have.property("grant_request_id");
              expect(details.grant_request_id).to.match(/not found/i);
          });
      }
  
      // ---------- Case: Not pending ----------
      else if (details.grant_request_id && /not pending/i.test(details.grant_request_id)) {
          test("‚ùå Case: grant_request_not_pending", function () {
              expect(details).to.have.property("grant_request_id");
              expect(details.grant_request_id).to.match(/not pending/i);
          });
      }
  
      // ---------- Case: Invalid fields (cannot be blank) ----------
      else if (
          Object.values(details).some(v => /cannot be blank/i.test(v))
      ) {
          test("‚ùå Case: invalid_fields", function () {
              Object.keys(details).forEach(k => {
                  expect(details[k]).to.match(/cannot be blank/i);
              });
          });
      }
  
      // ---------- Case: Not authorized ----------
      else if (details.responder_id && /not authorized/i.test(details.responder_id)) {
          test("‚ùå Case: not_authorized", function () {
              expect(details).to.have.property("responder_id");
              expect(details.responder_id).to.match(/not authorized/i);
          });
      }
  
      // ---------- Unknown validation shape ----------
      else {
          test("‚ö†Ô∏è Unrecognized validation error shape", function () {
              expect.fail("Validation error did not match any known case. Details: " + JSON.stringify(details));
          });
      }
  }
  
  // ================= UNEXPECTED (non-200/non-400) =================
  else {
      test("‚ö†Ô∏è Unexpected response", function () {
          expect.fail(`Unexpected status ${statusCode}`);
      });
  }
  
}

settings {
  encodeUrl: true
}
