meta {
  name: Resource Create - Success
  type: http
  seq: 1
}

post {
  url: {{api_host}}/v1/authorize/resources
  body: json
  auth: inherit
}

headers {
  Authorization: Bearer eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJ1c2VyaWQiOiIwMUtHSDdHVlFUOFE5UUs2NllEMFg5RlZEVyIsImRpZCI6IjEyNy4wLjAuMSIsInJvbGVzIjpbInBhc3N3b3JkIl0sImlzcyI6Im5pa2tpLWVycCIsImV4cCI6MTc3MDEwOTc1MywiaWF0IjoxNzcwMTA2MTUzfQ.Z25HG5BHlQ78FuudkeoffneNXsFB2XcNu1XRx7VeT6tLlm3qoIKZmbw5gdOaVq9mXAml45Yv34AEhtKuyxQt5w
}

body:json {
  {
      "name": "AuthProduct",
      "resourceType": "nikki_application",
      "resourceRef": "12345678901234567890123456",
      "scopeType": "org"
  }
}

script:pre-request {
  let payload = req.getBody();
  
  function randomString(length = 6) {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    return Array.from({ length }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
  }
  
  const rand = randomString();
  
  if (payload.name) {
    payload.name = payload.name.replace(/[^a-zA-Z0-9]/g, '') + rand;
  }
  
  if (payload.resourceType === "nikki_application") {
    payload.resourceRef = "01" + randomString(24);
  }
  
  req.setBody(payload);
  bru.setVar("resource_name", payload.name);
  
  console.log("âœ… Final request payload:", payload);
  
}

script:post-response {
  let body;
  try {
    body = res.getBody();
    console.log("ðŸ“¦ Success response:", body);
  } catch (e) {
    expect.fail("âŒ Failed to parse");
  }
  
  test("Status code is 200 or 201", () => {
    const status = res.getStatus();
    expect([200, 201]).to.include(status);
  });
  
  test("Response body contains id, createdAt, etag", () => {
    expect(body).to.be.an("object");
    expect(body).to.have.property("id").that.is.a("string").with.length.greaterThan(25);
    expect(body).to.have.property("createdAt").that.is.a("number");
    expect(body).to.have.property("etag").that.is.a("string");
  });
  
  if (res.getStatus() === 201) {
    bru.setVar("resource_id", body.id);
    bru.setVar("etag", body.etag)
  }
  
}

settings {
  encodeUrl: true
  timeout: 0
}
