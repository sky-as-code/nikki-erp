meta {
  name: Role Suite Create -Client error (Invalid Fields)
  type: http
  seq: 3
}

post {
  url: {{api_host}}/v1/authorize/role-suites
  body: json
  auth: inherit
}

body:json {
  {
      "invalid_field": "Ã¬nvalid_value"
  }
}

script:post-response {
  /**
   * ðŸ§ª Post-response script: Validate all possible outcomes of creating a Role Suite
   */
  
  let body;
  let isJsonValid = true;
  
  try {
    body = res.getBody();
    console.log("ðŸ“¥ Response body:", body);
  } catch (e) {
    isJsonValid = false;
    expect.fail("âŒ Response is not valid JSON");
  }
  
  const status = res.getStatus();
  
  /**
   * ðŸ”¹ Define common reusable schemas
   */
  const schemas = {
    success: {
      type: "object",
      required: ["id", "etag", "createdAt"],
      properties: {
        id: { type: "string" },
        etag: { type: "string" },
        createdAt: { type: "number" }
      },
      additionalProperties: true
    },
    error: {
      type: "object",
      required: ["code", "details"],
      properties: {
        code: { type: "string" },
        details: { type: "object" }
      },
      additionalProperties: true
    }
  };
  
  /**
   * ðŸ”¹ Utility logger
   */
  function logResult(label, condition) {
    const emoji = condition ? "âœ…" : "âŒ";
    console.log(`${emoji} ${label}`);
  }
  
  /**
   * ðŸ”¹ Expected Behaviors
   * 201 â†’ Success create
   * 400 â†’ Validation error (invalid fields / duplicate / missing / not found)
   * Others â†’ Unexpected
   */
  
  // âœ… CASE 1: Success
  if (status === 201 && isJsonValid) {
    test("âœ… Status code is 201 Created", () => {
      expect(tv4.validate(body, schemas.success)).to.be.true;
    });
    logResult("Schema valid for success", tv4.validate(body, schemas.success));
  
    // Save variables for reuse
    if (body?.id && body?.etag) {
      bru.setVar("rolesuite_id", body.id);
      bru.setVar("etag", body.etag);
      console.log("ðŸ’¾ Saved rolesuite_id & etag");
    } else {
      console.warn("âš ï¸ Missing id or etag in response");
    }
  }
  
  // âŒ CASE 2: Validation error
  else if (status === 400 && isJsonValid && body.code === "validation_error") {
    test("âŒ Validation error returned as expected", () => {
      expect(tv4.validate(body, schemas.error)).to.be.true;
      expect(Object.keys(body.details).length).to.be.greaterThan(0);
    });
  
    // Log validation fields in readable format
    Object.entries(body.details || {}).forEach(([field, msg]) => {
      console.warn(`âš ï¸ [${field}] â†’ ${msg}`);
    });
  }
  
  // âš ï¸ CASE 3: Unexpected
  else {
    test("âš ï¸ Unexpected response", () => {
      expect.fail(`Unexpected status ${status} or invalid schema`);
    });
    console.error("ðŸ§¨ Raw response for debugging:", body);
  }
  
  /**
   * âœ… Summary
   */
  console.log("ðŸ§¾ Role Suite Create Test Summary:");
  console.log(`   â†³ Status: ${status}`);
  console.log(`   â†³ JSON valid: ${isJsonValid}`);
  if (body?.code) console.log(`   â†³ Error code: ${body.code}`);
  
}

settings {
  encodeUrl: true
}
