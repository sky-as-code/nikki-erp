meta {
  name: Entitlement Create
  type: http
  seq: 1
}

post {
  url: {{api_host}}/v1/authorize/entitlements
  body: json
  auth: inherit
}

body:json {
  {
      "name": "Author Identdity - Readonly",
      "actionId": "{{action_id}}",
      "actionExpr": "{{action_name}}:*.{{resource_name}}",
      "resourceId": "{{resource_id}}",
      "scopeRef": "01JWNY20G23KD4RV5VWYABQYHD",
      "subjectType": "custom",
      "subjectRef": "custom",
      "createdBy": "{{user_id}}"
  }
}

script:pre-request {
  let rawBody = req.getBody().raw;
  
  let payload;
  try {
      payload = JSON.parse(rawBody);
  } catch (e) {
      console.error("‚ùå Failed to parse JSON body:", e);
      return;
  }
  
  // Generate a 6-character alphanumeric string
  function randomString(length = 6) {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      return Array.from({ length }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
  }
  
  const rand = randomString();
  
  // Randomize name if present
  if (payload.name) {
      const cleanedName = payload.name.replace(/[^\w\s-]/g, '').trim();
      payload.name = `${cleanedName} - ${rand}`;
  }
  
  // Optional: regenerate scopeRef if needed (ULID-style)
  if (payload.scopeRef && payload.scopeRef.length !== 26) {
      payload.scopeRef = "01" + randomString(24); // ULID 26 characters
  }
  
  bru.setVar("entitlement_name", payload.name);
  req.getBody().raw = JSON.stringify(payload, null, 2);
  
  console.log("‚úÖ Final request payload:", payload);
  
}

script:post-response {
  const schema = {
      type: "object",
      required: ["id", "etag", "createdAt"],
      properties: {
          id: { type: "string" },
          etag: { type: "string" },
          createdAt: { type: "integer" },
          name: { type: "string" },
          actionId: { type: "string" },
          actionExpr: { type: "string" },
          resourceId: { type: "string" },
          scopeRef: { type: "string" },
          subjectType: { type: "string" },
          subjectRef: { type: "string" },
          createdBy: { type: "string" }
      },
      additionalProperties: true
  };
  
  let isStatusValid = false;
  test("Status code is 200 or 201", function () {
      isStatusValid = [200, 201].includes(res.getStatus());
      expect(isStatusValid).to.be.true;
  });
  
  let body;
  let isJsonValid = true;
  try {
      body = res.getBody();
  } catch (e) {
      isJsonValid = false;
      expect.fail("‚ùå Failed to parse response JSON");
  }
  
  let isSchemaValid = false;
  if (isStatusValid && isJsonValid) {
      test("Response matches expected schema", function () {
          expect(tv4.validate(body, schema)).to.be.true;
          isSchemaValid = true;
      });
  } else {
      console.warn("‚ö†Ô∏è Skip schema check due to invalid status or JSON");
  }
  
  if (isStatusValid && isJsonValid && isSchemaValid) {
      bru.setVar("entitlement_id", body.id);
      bru.setVar("etag", body.etag);
      console.log("üì¶ Saved entitlement_id and etag:", body.id, body.etag);
  } else {
      console.warn("üö´ Not saving vars due to failed validation");
  }
  
}

settings {
  encodeUrl: true
}
