meta {
  name: User Update - Success
  type: http
  seq: 1
}

put {
  url: {{api_host}}/v1/identity/users/{{user_id}}
  body: json
  auth: inherit
}

body:json {
  {
      "avatarUrl": "{{$randomUrl}}/{{$randomWord}}.jpg",
      "displayName": "{{$randomFullName}}",
      "email": "{{$randomEmail}}",
      "etag": "{{etag}}",
      "statusValue": "archived"
  }
  
}

script:post-response {
  const tv4 = require('tv4');
  
  const schema = {
      type: "object",
      required: ["id", "etag", "updatedAt"],
      properties: {
          id: {
              type: "string",
              minLength: 1,
          },
          etag: {
              type: "string",
              minLength: 1,
          },
          updatedAt: {
              type: "integer",
              minimum: 1,
          }
      },
      additionalProperties: false
  };
  
  test("Status code is 200", function () {
      expect(res.getStatus()).to.equal(200);
  });
  
  test("Response matches expected JSON schema", function () {
    const valid = tv4.validate(res.getBody(), schema);
    expect(tv4.error).not.to.exist;
    expect(valid).to.be.true;
  });
  
  const requestBody = req.getBody();
  bru.setVar('email', requestBody.email);
  
  const { id, etag, email } = res.getBody();
  const previousEtag = bru.getVar("etag");
  
  test("Response 'etag' is different from previous", () => {
      expect(etag).to.not.eql(previousEtag);
  });
  
  id && bru.setVar('user_id', id);
  etag && bru.setVar('etag', etag);
  email && bru.setVar('email', email);
  
}

settings {
  encodeUrl: true
}
